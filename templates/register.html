<!-- =========================================================================
     QUANTUM-SAFE E-VOTING SYSTEM - REGISTRATION PAGE
     =========================================================================
     File: templates/register.html
     Purpose: User registration form with optional face capture
     ========================================================================= -->
{% extends "base.html" %}

{% block title %}Register - Quantum-Safe Voting{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 col-lg-7 mx-auto">
        <!-- Registration Card -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="bi bi-person-plus"></i> Create Your Account
                </h4>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    Register to participate in the quantum-safe election.
                </p>
                
                <!-- Registration Form -->
                <form method="POST" action="{{ url_for('register') }}" id="registerForm">
                    <!-- Username Field -->
                    <div class="mb-3">
                        <label for="username" class="form-label">
                            <i class="bi bi-person"></i> Username *
                        </label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="username" 
                            name="username" 
                            placeholder="Choose a username"
                            required
                            minlength="3"
                            maxlength="30"
                            pattern="[A-Za-z][A-Za-z0-9_]*"
                            title="Username must start with a letter and contain only letters, numbers, and underscores">
                        <div class="form-text">
                            3-30 characters, letters, numbers, and underscores only
                        </div>
                    </div>
                    
                    <!-- Email Field -->
                    <div class="mb-3">
                        <label for="email" class="form-label">
                            <i class="bi bi-envelope"></i> Email Address *
                        </label>
                        <input 
                            type="email" 
                            class="form-control" 
                            id="email" 
                            name="email" 
                            placeholder="your.email@example.com"
                            required
                            maxlength="100">
                        <div class="form-text">
                            We'll never share your email with anyone
                        </div>
                    </div>
                    
                    <!-- Password Field -->
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="bi bi-lock"></i> Password *
                        </label>
                        <input 
                            type="password" 
                            class="form-control" 
                            id="password" 
                            name="password" 
                            placeholder="Create a strong password"
                            required
                            minlength="8">
                        <div class="form-text">
                            At least 8 characters with letters and numbers
                        </div>
                    </div>
                    
                    <!-- Confirm Password Field -->
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">
                            <i class="bi bi-lock-fill"></i> Confirm Password *
                        </label>
                        <input 
                            type="password" 
                            class="form-control" 
                            id="confirm_password" 
                            name="confirm_password" 
                            placeholder="Re-enter your password"
                            required>
                        <div class="invalid-feedback" id="passwordMismatch">
                            Passwords do not match
                        </div>
                    </div>
                    
                    <!-- Terms Agreement -->
                    <div class="mb-3 form-check">
                        <input 
                            type="checkbox" 
                            class="form-check-input" 
                            id="agreeTerms" 
                            required>
                        <label class="form-check-label" for="agreeTerms">
                            I agree to vote honestly and maintain election integrity *
                        </label>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Register Account
                        </button>
                    </div>
                </form>
            </div>
            <div class="card-footer text-center bg-light">
                <p class="mb-0">
                    Already have an account? 
                    <a href="{{ url_for('login') }}" class="text-decoration-none">
                        Login here
                    </a>
                </p>
            </div>
        </div>
        
        <!-- Face Registration Card (After Basic Registration) -->
        <div class="card mt-4" id="faceRegistrationCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-camera-fill"></i> Optional: Register Your Face
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill"></i>
                    <strong>Enhanced Security:</strong> Register your face for biometric login verification.
                    Your face data will be encrypted with Kyber-512 (quantum-safe).
                </div>
                
                <!-- Webcam Section -->
                <div class="text-center mb-3">
                    <div id="cameraSection">
                        <video id="faceVideo" width="320" height="240" autoplay style="border-radius: 10px; border: 3px solid #10b981;"></video>
                        <canvas id="faceCanvas" style="display: none;"></canvas>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" id="captureFaceBtn">
                                <i class="bi bi-camera"></i> Capture Face
                            </button>
                            <button type="button" class="btn btn-secondary" id="skipFaceBtn">
                                <i class="bi bi-skip-forward"></i> Skip for Now
                            </button>
                        </div>
                    </div>
                    
                    <!-- Captured Image Preview -->
                    <div id="capturedPreview" style="display: none;">
                        <img id="capturedImage" style="max-width: 320px; border-radius: 10px; border: 3px solid #10b981;">
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" id="confirmFaceBtn">
                                <i class="bi bi-check-circle"></i> Confirm & Register
                            </button>
                            <button type="button" class="btn btn-secondary" id="retakeFaceBtn">
                                <i class="bi bi-arrow-counterclockwise"></i> Retake
                            </button>
                        </div>
                    </div>
                    
                    <!-- Loading Spinner -->
                    <div id="faceLoadingSpinner" style="display: none;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="mt-2">Processing face data...</p>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="alert alert-light mt-3">
                    <strong>Tips for best results:</strong>
                    <ul class="mb-0 small">
                        <li>Ensure good lighting on your face</li>
                        <li>Look directly at the camera</li>
                        <li>Remove sunglasses if wearing</li>
                        <li>Use a neutral expression</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Security Notice -->
        <div class="alert alert-info mt-3">
            <small>
                <i class="bi bi-shield-lock-fill"></i>
                <strong>Privacy Notice:</strong> Your password is hashed with bcrypt. 
                Your vote will be completely anonymous. Face data (if registered) is encrypted with Kyber-512.
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Client-side password matching validation
document.getElementById('registerForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const confirmInput = document.getElementById('confirm_password');
    
    if (password !== confirmPassword) {
        e.preventDefault();
        confirmInput.classList.add('is-invalid');
        return false;
    }
    
    confirmInput.classList.remove('is-invalid');
    return true;
});

// Real-time password matching check
document.getElementById('confirm_password').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && password !== confirmPassword) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

// ============================================================================
// FACE REGISTRATION (POST-REGISTRATION)
// ============================================================================

// Check if we just registered (URL parameter)
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('registered') === 'true') {
    // Show face registration card
    document.getElementById('registerForm').closest('.card').style.display = 'none';
    document.getElementById('faceRegistrationCard').style.display = 'block';
    
    // Initialize webcam
    initializeWebcam();
}

let videoStream = null;

function initializeWebcam() {
    const video = document.getElementById('faceVideo');
    
    // Request webcam access
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
            videoStream = stream;
            video.srcObject = stream;
        })
        .catch(function(error) {
            console.error('Webcam error:', error);
            alert('Could not access webcam. Please check permissions.');
        });
}

// Capture face button
document.getElementById('captureFaceBtn').addEventListener('click', function() {
    const video = document.getElementById('faceVideo');
    const canvas = document.getElementById('faceCanvas');
    const capturedImage = document.getElementById('capturedImage');
    
    // Set canvas size to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0);
    
    // Get image data as base64
    const imageData = canvas.toDataURL('image/jpeg', 0.95);
    
    // Show preview
    capturedImage.src = imageData;
    document.getElementById('cameraSection').style.display = 'none';
    document.getElementById('capturedPreview').style.display = 'block';
    
    // Stop video stream
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
});

// Retake button
document.getElementById('retakeFaceBtn').addEventListener('click', function() {
    document.getElementById('cameraSection').style.display = 'block';
    document.getElementById('capturedPreview').style.display = 'none';
    initializeWebcam();
});

// Confirm and register face
document.getElementById('confirmFaceBtn').addEventListener('click', function() {
    const imageData = document.getElementById('capturedImage').src;
    
    // Show loading
    document.getElementById('capturedPreview').style.display = 'none';
    document.getElementById('faceLoadingSpinner').style.display = 'block';
    
    // Send to backend
    fetch('/register_face', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image: imageData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✓ Face registered successfully!\n\nYou can now use face verification to login.');
            window.location.href = '/login';
        } else {
            alert('✗ Face registration failed:\n' + data.message);
            document.getElementById('faceLoadingSpinner').style.display = 'none';
            document.getElementById('cameraSection').style.display = 'block';
            initializeWebcam();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error registering face. Please try again.');
        document.getElementById('faceLoadingSpinner').style.display = 'none';
        document.getElementById('cameraSection').style.display = 'block';
        initializeWebcam();
    });
});

// Skip face registration
document.getElementById('skipFaceBtn').addEventListener('click', function() {
    if (confirm('Skip face registration?\n\nYou can register your face later from your profile.')) {
        // Stop video stream
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }
        window.location.href = '/login';
    }
});
</script>
{% endblock %}